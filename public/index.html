<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GHG Emissions Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
            position: relative;
        }
        
        .header-download-btn {
            position: absolute;
            top: 0;
            right: 0;
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .header-download-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .year-filter {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .year-filter h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .year-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .year-btn {
            background: #ecf0f1;
            border: 2px solid #bdc3c7;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .year-btn:hover {
            background: #3498db;
            color: white;
            border-color: #3498db;
        }

        .year-btn.active {
            background: #e74c3c;
            color: white;
            border-color: #e74c3c;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.4rem;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .form-section {
            grid-column: 1 / -1;
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #34495e;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        button {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        button:hover {
            background: linear-gradient(135deg, #2980b9, #1f618d);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 1200px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        .kpi-card {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .records-table th,
        .records-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .records-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }

        .records-table tr:hover {
            background-color: #f8f9fa;
        }

        .override-badge {
            background: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
        }

        .scope-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .scope-1 { background: #e74c3c; color: white; }
        .scope-2 { background: #f39c12; color: white; }
        .scope-3 { background: #9b59b6; color: white; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .data-notice {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="header-download-btn" onclick="downloadDatabase()">Download Database</button>
            <h1>🌱 GHG Emissions Platform</h1>
            <p>Carbon Footprint Tracking & Reporting Dashboard</p>
        </div>


        <!-- Year Filter -->
        <div class="year-filter">
            <h3>📅 Select Year for Analysis</h3>
            <div class="year-buttons" id="yearButtons">
                <div class="year-btn">Loading years...</div>
            </div>
        </div>


        <!-- KPI Dashboard -->
        <div class="card">
            <h2>📊 Key Performance Indicators - <span id="kpiYear">Loading...</span></h2>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="totalEmissions">0</div>
                    <div class="kpi-label">Total Emissions (Million tCO₂e)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="emissionIntensity">0</div>
                    <div class="kpi-label">Intensity (kgCO₂e/tonne)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="yoyChange">N/A</div>
                    <div class="kpi-label">YoY Change</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="totalRecords">0</div>
                    <div class="kpi-label">Total Records</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="steelProduced">0</div>
                    <div class="kpi-label">Steel Produced (tonnes)</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="employeeCount">0</div>
                    <div class="kpi-label">Employee Count</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="productionHours">0</div>
                    <div class="kpi-label">Production Hours</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="energyConsumed">0</div>
                    <div class="kpi-label">Energy Consumed (kWh)</div>
                </div>
            </div>
        </div>

        <div class="dashboard">
            <!-- Year-over-Year Comparison -->
            <div class="card">
                <h2>📈 Year-over-Year Emissions</h2>
                <div class="chart-container">
                    <canvas id="yoyChart"></canvas>
                </div>
            </div>

            <!-- Emission Hotspots -->
            <div class="card">
                <h2>🔥 Emission Hotspots - <span id="hotspotsYear">Loading...</span></h2>
                <div class="chart-container">
                    <canvas id="hotspotsChart"></canvas>
                </div>
            </div>

            <!-- Monthly Trends -->
            <div class="card">
                <h2>📊 Monthly Emission Trends - <span id="trendsYear">Loading...</span></h2>
                <div class="chart-container">
                    <canvas id="trendsChart"></canvas>
                </div>
            </div>

            <!-- Scope Breakdown -->
            <div class="card">
                <h2>🎯 Emissions by Scope - <span id="scopeYear">Loading...</span></h2>
                <div class="chart-container">
                    <canvas id="scopeChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Recent Records -->
        <div class="card">
            <h2>📋 Recent Emission Records</h2>
            <div id="recordsContainer">
                <div class="loading">Loading records...</div>
            </div>
        </div>


        <!-- Data Entry Forms -->
        <div class="card form-section">
            <h2>📝 Data Entry</h2>
            <div class="form-grid">
                <!-- Emission Record Form -->
                <div>
                    <h3>Add Emission Record</h3>
                    <form id="emissionForm">
                        <div class="input-group">
                            <label for="activityDate">Activity Date:</label>
                            <input type="date" id="activityDate" required>
                        </div>
                        
                        <script>
                            // Set max date to today for activity date
                            document.getElementById('activityDate').max = new Date().toISOString().split('T')[0];
                        </script>
                        
                        <div class="input-group">
                            <label for="activityName">Activity:</label>
                            <select id="activityName" required>
                                <option value="">Select Activity</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="activityData">Quantity:</label>
                            <input type="number" id="activityData" step="0.01" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="unit">Unit:</label>
                            <input type="text" id="unit" readonly>
                        </div>
                        
                        <div class="input-group">
                            <label for="overrideCo2e">Override CO₂e (optional):</label>
                            <input type="number" id="overrideCo2e" step="0.01" placeholder="Leave blank for auto-calculation">
                        </div>
                        
                        <div class="input-group">
                            <label for="overrideReason">Override Reason:</label>
                            <input type="text" id="overrideReason" placeholder="Required if using override">
                        </div>
                        
                        <button type="submit">Add Emission Record</button>
                    </form>
                </div>

                <!-- Business Metrics Form -->
                <div>
                    <h3>Add Business Metric</h3>
                    <form id="metricsForm">
                        <div class="input-group">
                            <label for="metricDate">Date:</label>
                            <input type="date" id="metricDate" required>
                        </div>
                        
                        <script>
                            // Set max date to today for metric date
                            document.getElementById('metricDate').max = new Date().toISOString().split('T')[0];
                        </script>
                        
                        <div class="input-group">
                            <label for="metricName">Metric Name:</label>
                            <select id="metricName" required>
                                <option value="">Select Metric</option>
                                <option value="Tons of Steel Produced">Tons of Steel Produced</option>
                                <option value="Employee Count">Employee Count</option>
                                <option value="Production Hours">Production Hours</option>
                                <option value="Energy Consumed">Energy Consumed</option>
                                <option value="Raw Material Used">Raw Material Used</option>
                            </select>
                        </div>
                        
                        <div class="input-group">
                            <label for="metricValue">Value:</label>
                            <input type="number" id="metricValue" step="0.01" required>
                        </div>
                        
                        <div class="input-group">
                            <label for="metricUnit">Unit:</label>
                            <select id="metricUnit" required>
                                <option value="">Select Unit</option>
                                <option value="tonnes">Tonnes</option>
                                <option value="employees">Employees</option>
                                <option value="hours">Hours</option>
                                <option value="kWh">kWh</option>
                                <option value="units">Units</option>
                            </select>
                        </div>
                        
                        <button type="submit">Add Business Metric</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let yoyChart, hotspotsChart, trendsChart, scopeChart;
        let selectedYear = new Date().getFullYear();
        let availableYears = [];

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadAvailableYears();
            setupEventListeners();
            loadAvailableActivities();
            loadDashboard();
        });

        function setupEventListeners() {
            // Emission form submission
            document.getElementById('emissionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitEmissionRecord();
            });

            // Business metrics form submission
            document.getElementById('metricsForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitBusinessMetric();
            });
            
            // Activity selection change
            document.getElementById('activityName').addEventListener('change', function(e) {
                updateUnitField(e.target.value);
            });

            // Year filter clicks
            document.getElementById('yearButtons').addEventListener('click', function(e) {
                if (e.target.classList.contains('year-btn')) {
                    selectYear(parseInt(e.target.dataset.year));
                }
            });
        }

        async function loadAvailableYears() {
            try {
                const response = await fetch('/api/debug/quick-check');
                const data = await response.json();
                
                availableYears = [...new Set(data.breakdown_by_year_scope.map(item => parseInt(item.year)))].sort().reverse();
                
                // Set selectedYear to most recent available year if we have data
                if (availableYears.length > 0) {
                    selectedYear = availableYears[0]; // Most recent year (already sorted reverse)
                }
                
                // Log data for debugging
                const totalRecords = data.total_records;
                const yearsList = availableYears.join(', ');
                console.log(`Loaded data: ${totalRecords} records from ${yearsList}`);
                
                // Create year buttons
                const yearButtons = document.getElementById('yearButtons');
                yearButtons.innerHTML = '';
                
                if (availableYears.length === 0) {
                    yearButtons.innerHTML = '<div class="year-btn active">No data available</div>';
                    return;
                }
                
                availableYears.forEach(year => {
                    const btn = document.createElement('div');
                    btn.className = 'year-btn';
                    btn.dataset.year = year;
                    btn.textContent = year;
                    if (year === selectedYear) btn.classList.add('active');
                    yearButtons.appendChild(btn);
                });
                
                // Update year displays with the selected year
                document.getElementById('kpiYear').textContent = selectedYear;
                document.getElementById('hotspotsYear').textContent = selectedYear;
                document.getElementById('trendsYear').textContent = selectedYear;
                document.getElementById('scopeYear').textContent = selectedYear;
                
                console.log(`📅 Available years: ${yearsList}, Selected: ${selectedYear}`);
                
            } catch (error) {
                console.error('Error loading available years:', error);
            }
        }

        function selectYear(year) {
            selectedYear = year;
            
            // Update active button
            document.querySelectorAll('.year-btn').forEach(btn => {
                btn.classList.toggle('active', parseInt(btn.dataset.year) === year);
            });
            
            // Update year displays
            document.getElementById('kpiYear').textContent = year;
            document.getElementById('hotspotsYear').textContent = year;
            document.getElementById('trendsYear').textContent = year;
            document.getElementById('scopeYear').textContent = year;
            
            // Reload dashboard for selected year
            loadDashboard();
        }

        async function loadAvailableActivities() {
            try {
                const response = await fetch('/api/emission-factors');
                const factors = await response.json();
                
                const activitySelect = document.getElementById('activityName');
                const uniqueActivities = [...new Set(factors.map(f => f.activity_name))];
                
                activitySelect.innerHTML = '<option value="">Select Activity</option>';
                
                uniqueActivities.forEach(activity => {
                    const option = document.createElement('option');
                    option.value = activity;
                    option.textContent = activity;
                    activitySelect.appendChild(option);
                });
                
                console.log(`📋 Loaded ${uniqueActivities.length} available activities`);
                window.emissionFactors = factors;
                
            } catch (error) {
                console.error('Error loading activities:', error);
            }
        }

        function updateUnitField(activityName) {
            if (!window.emissionFactors || !activityName) {
                document.getElementById('unit').value = '';
                return;
            }
            
            const factor = window.emissionFactors.find(f => f.activity_name === activityName);
            if (factor) {
                document.getElementById('unit').value = factor.unit;
            }
        }

        async function loadDashboard() {
            try {
                await Promise.all([
                    loadKPIs(),
                    loadBusinessMetricsKPIs(),
                    loadYoYChart(),
                    loadHotspotsChart(),
                    loadTrendsChart(),
                    loadScopeChart(),
                    loadRecentRecords()
                ]);
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Failed to load dashboard data');
            }
        }

        async function loadKPIs() {
            try {
                const [emissionIntensity, records] = await Promise.all([
                    fetch(`/api/analytics/emission-intensity?year=${selectedYear}`).then(r => r.json()),
                    fetch('/api/emission-records').then(r => r.json())
                ]);

                // Filter records for selected year and previous year
                const yearRecords = records.filter(r => new Date(r.activity_date).getFullYear() === selectedYear);
                const prevYearRecords = records.filter(r => new Date(r.activity_date).getFullYear() === (selectedYear - 1));
                
                const totalEmissions = yearRecords.reduce((sum, r) => sum + r.calculated_co2e, 0);
                const prevTotalEmissions = prevYearRecords.reduce((sum, r) => sum + r.calculated_co2e, 0);

                // Calculate YoY change
                let yoyChange = 'N/A';
                if (prevTotalEmissions > 0) {
                    const changePercent = ((totalEmissions - prevTotalEmissions) / prevTotalEmissions) * 100;
                    yoyChange = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(1) + '%';
                }

                // Update KPI cards with better formatting
                // Convert to millions of tonnes for display
                const totalEmissionsMillions = totalEmissions / 1000000000;
                document.getElementById('totalEmissions').textContent = totalEmissionsMillions.toFixed(1);
                document.getElementById('emissionIntensity').textContent = emissionIntensity.intensity ? emissionIntensity.intensity.toFixed(2) : 'N/A';
                document.getElementById('yoyChange').textContent = yoyChange;
                document.getElementById('totalRecords').textContent = yearRecords.length;

            } catch (error) {
                console.error('Error loading KPIs:', error);
            }
        }

        async function loadBusinessMetricsKPIs() {
            try {
                const response = await fetch(`/api/business-metrics/summary?year=${selectedYear}`);
                const data = await response.json();

                // Reset all metrics to 0
                document.getElementById('steelProduced').textContent = '0';
                document.getElementById('employeeCount').textContent = '0';
                document.getElementById('productionHours').textContent = '0';
                document.getElementById('energyConsumed').textContent = '0';

                // Update metrics based on available data
                data.metrics.forEach(metric => {
                    if (metric.metric_name === 'Tons of Steel Produced') {
                        document.getElementById('steelProduced').textContent = Math.round(metric.total_value).toLocaleString();
                    } else if (metric.metric_name === 'Employee Count') {
                        // For employee count, show the latest value (average makes more sense)
                        document.getElementById('employeeCount').textContent = Math.round(metric.avg_value || metric.total_value);
                    } else if (metric.metric_name === 'Production Hours') {
                        document.getElementById('productionHours').textContent = Math.round(metric.total_value).toLocaleString();
                    } else if (metric.metric_name === 'Energy Consumed') {
                        document.getElementById('energyConsumed').textContent = Math.round(metric.total_value).toLocaleString();
                    }
                });
                
                console.log(`📊 Business metrics for ${selectedYear}:`, data.metrics);

            } catch (error) {
                console.error('Error loading business metrics KPIs:', error);
            }
        }

        async function loadYoYChart() {
            try {
                // YoY chart shows ALL years regardless of selection
                const response = await fetch(`/api/analytics/yoy-emissions-debug`);
                const data = await response.json();

                const ctx = document.getElementById('yoyChart').getContext('2d');
                
                if (yoyChart) yoyChart.destroy();

                // Use available years from debug data
                const availableData = data.data;
                const years = [...new Set(availableData.map(d => d.year))].sort();
                
                const scope1Data = [], scope2Data = [], scope3Data = [];

                years.forEach(year => {
                    const scope1 = availableData.find(d => d.year == year && d.scope == 1);
                    const scope2 = availableData.find(d => d.year == year && d.scope == 2);
                    const scope3 = availableData.find(d => d.year == year && d.scope == 3);
                    
                    scope1Data.push((scope1?.total_co2e || 0) / 1000000000); // Convert to million tonnes
                    scope2Data.push((scope2?.total_co2e || 0) / 1000000000);
                    scope3Data.push((scope3?.total_co2e || 0) / 1000000000);
                });

                const datasets = [];
                
                // Always add Scope 1
                datasets.push({
                    label: 'Scope 1 (Direct)',
                    data: scope1Data,
                    backgroundColor: 'rgba(231, 76, 60, 0.8)',
                    borderColor: 'rgba(231, 76, 60, 1)',
                    borderWidth: 1
                });

                // Add Scope 2 if data exists
                if (scope2Data.some(val => val > 0)) {
                    datasets.push({
                        label: 'Scope 2 (Indirect)',
                        data: scope2Data,
                        backgroundColor: 'rgba(243, 156, 18, 0.8)',
                        borderColor: 'rgba(243, 156, 18, 1)',
                        borderWidth: 1
                    });
                }
                
                // Always add Scope 3 (even if small values)
                datasets.push({
                    label: 'Scope 3 (Value Chain)',
                    data: scope3Data,
                    backgroundColor: 'rgba(155, 89, 182, 0.8)',
                    borderColor: 'rgba(155, 89, 182, 1)',
                    borderWidth: 1
                });

                yoyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { stacked: true },
                            y: { 
                                stacked: true,
                                title: { display: true, text: 'Emissions (Million tCO₂e)' },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'All Years Emissions Comparison by Scope' }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading YoY chart:', error);
            }
        }

        async function loadHotspotsChart() {
            try {
                const response = await fetch(`/api/analytics/emission-hotspots?year=${selectedYear}`);
                const data = await response.json();

                const ctx = document.getElementById('hotspotsChart').getContext('2d');
                
                if (hotspotsChart) hotspotsChart.destroy();

                if (!data.hotspots || data.hotspots.length === 0) {
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#7f8c8d';
                    ctx.textAlign = 'center';
                    ctx.fillText(`No data available for ${selectedYear}`, ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                const labels = data.hotspots.slice(0, 8).map(h => h.activity_name);
                const values = data.hotspots.slice(0, 8).map(h => parseFloat(h.percentage));
                const colors = [
                    '#e74c3c', '#f39c12', '#27ae60', '#3498db', '#9b59b6', '#e67e22', '#1abc9c', '#34495e'
                ];

                hotspotsChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: `Top Emission Sources (%)` },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed}%`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading hotspots chart:', error);
            }
        }

        async function loadTrendsChart() {
            try {
                const response = await fetch(`/api/analytics/monthly-trends?year=${selectedYear}`);
                const data = await response.json();

                const ctx = document.getElementById('trendsChart').getContext('2d');
                
                if (trendsChart) trendsChart.destroy();

                if (!data.data || data.data.length === 0) {
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#7f8c8d';
                    ctx.textAlign = 'center';
                    ctx.fillText(`No monthly data for ${selectedYear}`, ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                // Group data by month
                const monthlyTotals = {};
                data.data.forEach(item => {
                    if (!monthlyTotals[item.month]) {
                        monthlyTotals[item.month] = 0;
                    }
                    monthlyTotals[item.month] += item.total_co2e / 1000000000; // Convert to million tonnes
                });

                const labels = Object.keys(monthlyTotals).sort();
                const values = labels.map(month => monthlyTotals[month]);

                trendsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.map(month => {
                            const [year, m] = month.split('-');
                            return new Date(year, m - 1).toLocaleDateString('en-US', { month: 'short' });
                        }),
                        datasets: [{
                            label: 'Monthly Emissions',
                            data: values,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { 
                                title: { display: true, text: 'Emissions (Million tCO₂e)' },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: `Monthly Trends for ${selectedYear}` }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading trends chart:', error);
            }
        }

        async function loadScopeChart() {
            try {
                const response = await fetch(`/api/analytics/yoy-emissions-debug`);
                const data = await response.json();

                const ctx = document.getElementById('scopeChart').getContext('2d');
                
                if (scopeChart) scopeChart.destroy();

                // Get data for selected year
                const yearData = data.data.filter(d => d.year == selectedYear);
                
                if (yearData.length === 0) {
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#7f8c8d';
                    ctx.textAlign = 'center';
                    ctx.fillText(`No scope data for ${selectedYear}`, ctx.canvas.width/2, ctx.canvas.height/2);
                    return;
                }

                const scope1Total = yearData.find(d => d.scope == 1)?.total_co2e || 0;
                const scope2Total = yearData.find(d => d.scope == 2)?.total_co2e || 0;
                const scope3Total = yearData.find(d => d.scope == 3)?.total_co2e || 0;

                const total = scope1Total + scope2Total + scope3Total;
                const scope1Percent = total > 0 ? ((scope1Total / total) * 100).toFixed(1) : 0;
                const scope2Percent = total > 0 ? ((scope2Total / total) * 100).toFixed(1) : 0;
                const scope3Percent = total > 0 ? ((scope3Total / total) * 100).toFixed(1) : 0;

                const labels = [];
                const values = [];
                const colors = [];

                if (scope1Percent > 0) {
                    labels.push('Scope 1 (Direct)');
                    values.push(scope1Percent);
                    colors.push('#e74c3c');
                }
                if (scope2Percent > 0) {
                    labels.push('Scope 2 (Indirect)');
                    values.push(scope2Percent);
                    colors.push('#f39c12');
                }
                if (scope3Percent > 0) {
                    labels.push('Scope 3 (Value Chain)');
                    values.push(scope3Percent);
                    colors.push('#9b59b6');
                }

                scopeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' },
                            title: { display: true, text: `${selectedYear} Scope Breakdown (%)` },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.label}: ${context.parsed}%`;
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading scope chart:', error);
            }
        }

        async function loadRecentRecords() {
            try {
                const response = await fetch('/api/emission-records');
                const records = await response.json();

                const container = document.getElementById('recordsContainer');
                
                if (records.length === 0) {
                    container.innerHTML = '<p>No emission records found.</p>';
                    return;
                }

                const tableHTML = `
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Activity</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>CO₂e (kg)</th>
                                <th>Scope</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${records.slice(0, 10).map(record => `
                                <tr>
                                    <td>${new Date(record.activity_date).toLocaleDateString()}</td>
                                    <td>${record.activity_name}</td>
                                    <td>${record.activity_data.toLocaleString()}</td>
                                    <td>${record.unit}</td>
                                    <td>${record.calculated_co2e.toLocaleString()}</td>
                                    <td><span class="scope-badge scope-${record.scope}">Scope ${record.scope}</span></td>
                                    <td>${record.is_override ? '<span class="override-badge">Override</span>' : 'Calculated'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                container.innerHTML = tableHTML;

            } catch (error) {
                console.error('Error loading records:', error);
                document.getElementById('recordsContainer').innerHTML = '<p class="error">Error loading records</p>';
            }
        }

        async function submitEmissionRecord() {
            try {
                const formData = {
                    activity_date: document.getElementById('activityDate').value,
                    activity_name: document.getElementById('activityName').value,
                    activity_data: parseFloat(document.getElementById('activityData').value),
                    unit: document.getElementById('unit').value,
                    override_co2e: document.getElementById('overrideCo2e').value ? 
                        parseFloat(document.getElementById('overrideCo2e').value) : null,
                    override_reason: document.getElementById('overrideReason').value
                };

                if (formData.override_co2e && !formData.override_reason) {
                    showError('Override reason is required when providing override CO₂e value');
                    return;
                }

                const response = await fetch('/api/emission-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                const result = await response.json();
                showSuccess(`Emission record added! CO₂e: ${(result.calculated_co2e/1000).toFixed(2)} tCO₂e`);
                
                document.getElementById('emissionForm').reset();
                await loadDashboard();

            } catch (error) {
                console.error('Error submitting emission record:', error);
                showError(error.message);
            }
        }

        async function submitBusinessMetric() {
            try {
                const formData = {
                    date: document.getElementById('metricDate').value,
                    metric_name: document.getElementById('metricName').value,
                    value: parseFloat(document.getElementById('metricValue').value),
                    unit: document.getElementById('metricUnit').value
                };

                const response = await fetch('/api/business-metrics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error);
                }

                showSuccess('Business metric added successfully!');
                document.getElementById('metricsForm').reset();
                await loadKPIs();

            } catch (error) {
                console.error('Error submitting business metric:', error);
                showError(error.message);
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '20px';
            errorDiv.style.right = '20px';
            errorDiv.style.zIndex = '1000';
            errorDiv.style.maxWidth = '400px';
            
            document.body.appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            successDiv.style.position = 'fixed';
            successDiv.style.top = '20px';
            successDiv.style.right = '20px';
            successDiv.style.zIndex = '1000';
            successDiv.style.maxWidth = '400px';
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 5000);
        }

        async function downloadDatabase() {
            try {
                const response = await fetch('/api/download/database');
                
                if (!response.ok) {
                    throw new Error('Failed to download database');
                }

                // Create a blob from the response
                const blob = await response.blob();
                
                // Create a download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = 'emissions_database.db';
                
                document.body.appendChild(a);
                a.click();
                
                // Cleanup
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccess('Database downloaded successfully!');
                
            } catch (error) {
                console.error('Error downloading database:', error);
                showError('Failed to download database');
            }
        }
    </script>
</body>
</html>